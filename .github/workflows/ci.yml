# CI Pipeline - Optimized without .next rename workaround
# Location: .github/workflows/ci.yml
# Version: Stage 3 - Removed unnecessary rename logic

name: CI Pipeline

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  validate-and-build:
    name: Validate and Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run tests
        run: npm test
      
      - name: Build project
        run: |
          echo "🏗️ Building project..."
          npm run build
          
          # Verify build succeeded
          if [ ! -d ".next" ]; then
            echo "❌ Build failed - .next directory not found"
            exit 1
          fi
          
          echo "✅ Build complete"
          echo "📊 Build stats:"
          echo "  Total size: $(du -sh .next | cut -f1)"
          echo "  Static assets: $(du -sh .next/static | cut -f1)"
          echo "  Server bundles: $(du -sh .next/server | cut -f1)"
      
      # FOR PULL REQUESTS: Create lightweight verification report
      - name: Create PR verification artifact
        if: github.event_name == 'pull_request'
        run: |
          echo "📝 Creating PR verification report..."
          
          mkdir -p pr-verification
          
          echo "Build Verification Report" > pr-verification/build-report.txt
          echo "=========================" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "PR #${{ github.event.pull_request.number }}" >> pr-verification/build-report.txt
          echo "Commit: ${{ github.sha }}" >> pr-verification/build-report.txt
          echo "Branch: ${{ github.head_ref }}" >> pr-verification/build-report.txt
          echo "Build Time: $(date)" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "Build Statistics:" >> pr-verification/build-report.txt
          echo "- Total .next size: $(du -sh .next | cut -f1)" >> pr-verification/build-report.txt
          echo "- Source files: $(find src -type f -name '*.js' -o -name '*.jsx' -o -name '*.ts' -o -name '*.tsx' 2>/dev/null | wc -l)" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "✅ All checks passed successfully" >> pr-verification/build-report.txt
      
      - name: Upload PR verification artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: pr-verification-${{ github.event.pull_request.number }}-${{ github.sha }}
          path: pr-verification/
          retention-days: 2
          compression-level: 6
      
      # FOR MAIN BRANCH: Create deployment package
      - name: Prepare deployment package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "📦 Creating deployment package..."
          
          mkdir -p deployment-package
          
          # Copy .next directory directly (no renaming needed!)
          echo "📁 Copying .next directory..."
          cp -r .next deployment-package/
          
          # Copy other required files
          echo "📁 Copying production files..."
          cp -r public deployment-package/ 2>/dev/null || echo "ℹ️ No public directory"
          cp -r src deployment-package/  # Will remove this in Stage 4
          cp package.json deployment-package/
          cp package-lock.json deployment-package/
          cp next.config.mjs deployment-package/
          
          # CRITICAL: Remove cache to reduce size from 569MB to ~15MB
          echo "🧹 Removing development cache..."
          rm -rf deployment-package/.next/cache
          
          # Remove source maps for smaller size
          find deployment-package -name "*.map" -type f -delete 2>/dev/null || true
          
          # Verify package integrity
          echo "🔍 Verifying deployment package..."
          if [ ! -d "deployment-package/.next" ]; then
            echo "❌ FATAL: .next missing from package!"
            exit 1
          fi
          
          if [ ! -d "deployment-package/.next/static" ]; then
            echo "❌ FATAL: .next/static missing!"
            exit 1
          fi
          
          if [ ! -d "deployment-package/.next/server" ]; then
            echo "❌ FATAL: .next/server missing!"
            exit 1
          fi
          
          echo "✅ Package verified successfully"
          echo "📊 Final package size: $(du -sh deployment-package | cut -f1)"
          echo "📊 .next size (without cache): $(du -sh deployment-package/.next | cut -f1)"
      
      # Upload deployment artifact with hidden files support
      - name: Upload deployment artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package-${{ github.sha }}
          path: deployment-package/
          retention-days: 14
          compression-level: 6
          include-hidden-files: true  # This flag handles .next correctly
      
      - name: Deployment artifact summary
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "📊 Deployment package created successfully!"
          echo ""
          echo "Package contents:"
          echo "  - .next/ (compiled application)"
          echo "  - src/ (source code - will be removed in Stage 4)"
          echo "  - public/ (static assets)"
          echo "  - package.json, package-lock.json"
          echo "  - next.config.mjs"
          echo ""
          echo "🚀 Ready for deployment!"