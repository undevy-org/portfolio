# CI Pipeline - With Staging Support
# Location: .github/workflows/ci.yml
# Purpose: Validate PRs and prepare staging deployments

name: CI Pipeline

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  validate-and-build:
    name: Validate and Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-modules-
      
      - name: Install dependencies with cache optimization
        env:
          EMERGENCY_NPM_BYPASS: ${{ vars.EMERGENCY_NPM_BYPASS }}
        timeout-minutes: 4
        run: |
          echo "🚀 Phase 1: Optimized npm installation with dual cache strategy"
          echo "📊 Environment check:"
          echo "- Node version: $(node --version)"
          echo "- NPM version: $(npm --version)"
          echo "- Registry: $(npm config get registry)"
          echo "- Cache location: $(npm config get cache)"
          echo "- Emergency bypass: ${EMERGENCY_NPM_BYPASS:-false}"
          
          # Check cache status
          if [ -d "node_modules" ]; then
            echo "- node_modules cache: HIT ($(du -sh node_modules 2>/dev/null | cut -f1 || echo 'unknown'))"
            cache_hit="true"
          else
            echo "- node_modules cache: MISS"
            cache_hit="false"
          fi
          
          # Check if emergency bypass is enabled
          if [ "${EMERGENCY_NPM_BYPASS}" = "true" ]; then
            echo "🚨 Emergency bypass enabled - using simple npm ci"
            npm ci --timeout=300000
            exit 0
          fi
          
          # Start timer for performance metrics
          start_time=$(date +%s)
          
          echo "📦 Installing dependencies with cache optimization..."
          
          # Phase 1: Cache-optimized installation with single attempt
          if npm ci --prefer-offline --no-audit --no-fund --timeout=180000; then
            end_time=$(date +%s)
            duration=$((end_time - start_time))
            echo "✅ Dependencies installed successfully in ${duration} seconds"
            
            # Performance metrics
            echo "NPM_INSTALL_DURATION=${duration}" >> $GITHUB_ENV
            echo "NPM_INSTALL_ATTEMPTS=1" >> $GITHUB_ENV
            echo "NPM_CACHE_HIT=${cache_hit}" >> $GITHUB_ENV
            echo "NPM_REGISTRY_USED=primary" >> $GITHUB_ENV
            
            echo "npm_install_duration=${duration}" >> $GITHUB_STEP_SUMMARY
            echo "npm_install_attempts=1" >> $GITHUB_STEP_SUMMARY
            echo "npm_cache_strategy=prefer-offline" >> $GITHUB_STEP_SUMMARY
            echo "npm_cache_hit=${cache_hit}" >> $GITHUB_STEP_SUMMARY
            echo "npm_registry_used=primary" >> $GITHUB_STEP_SUMMARY
            
          else
            end_time=$(date +%s)
            duration=$((end_time - start_time))
            echo "❌ Installation failed after ${duration} seconds"
            echo "📊 Failure diagnostics:"
            echo "- Exit code: $?"
            echo "- Duration: ${duration}s"
            echo "- Registry: $(npm config get registry)"
            echo "- Network: $(curl -s --connect-timeout 5 https://registry.npmjs.org/ > /dev/null && echo 'OK' || echo 'FAILED')"
            
            # Log failure metrics
            echo "NPM_INSTALL_DURATION=${duration}" >> $GITHUB_ENV
            echo "NPM_INSTALL_ATTEMPTS=1" >> $GITHUB_ENV
            echo "NPM_CACHE_HIT=${cache_hit}" >> $GITHUB_ENV
            echo "NPM_FAILURE_REASON=phase1_failed" >> $GITHUB_ENV
            
            echo "npm_install_duration=${duration}" >> $GITHUB_STEP_SUMMARY
            echo "npm_install_attempts=1" >> $GITHUB_STEP_SUMMARY
            echo "npm_cache_hit=${cache_hit}" >> $GITHUB_STEP_SUMMARY
            echo "npm_failure_reason=phase1_failed" >> $GITHUB_STEP_SUMMARY
            
            echo "💀 Phase 1 installation failed."
            exit 1
          fi
          
          echo "📋 Final dependency verification:"
          npm list --depth=0 || echo "⚠️ Some dependencies may have issues, but installation completed"
          
          echo "🎉 Phase 1 cache-optimized installation complete!"
      
      - name: Run linter
        run: npm run lint
      
      - name: Run tests
        run: npm test
      
      - name: Build project
        env:
          PORTFOLIO_TITLE: ${{ secrets.PORTFOLIO_TITLE }}
          NEXT_PUBLIC_WEB3_SHARED_ACCESS_CODE: ${{ secrets.NEXT_PUBLIC_WEB3_SHARED_ACCESS_CODE }}
          NEXT_PUBLIC_REOWN_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_REOWN_PROJECT_ID }}
          MASTER_CODE: ${{ secrets.MASTER_CODE }}
        run: |
          echo "🏗️ Building project..."
          npm run build
          
          # Verify build succeeded
          if [ ! -d ".next" ]; then
            echo "❌ Build failed - .next directory not found"
            exit 1
          fi
          
          echo "✅ Build complete"
          echo "📊 Build stats:"
          echo "  Total size: $(du -sh .next | cut -f1)"
          echo "  Static assets: $(du -sh .next/static | cut -f1)"
          echo "  Server bundles: $(du -sh .next/server | cut -f1)"
      
      - name: Create PR verification artifact
        if: github.event_name == 'pull_request'
        run: |
          echo "📄 Creating PR verification report..."
          
          mkdir -p pr-verification
          
          echo "Build Verification Report" > pr-verification/build-report.txt
          echo "=========================" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "PR #${{ github.event.pull_request.number }}" >> pr-verification/build-report.txt
          echo "Commit: ${{ github.sha }}" >> pr-verification/build-report.txt
          echo "Branch: ${{ github.head_ref }}" >> pr-verification/build-report.txt
          echo "Build Time: $(date)" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "Build Statistics:" >> pr-verification/build-report.txt
          echo "- Total .next size: $(du -sh .next | cut -f1)" >> pr-verification/build-report.txt
          echo "- Source files analyzed: $(find src -type f -name '*.js' -o -name '*.jsx' -o -name '*.ts' -o -name '*.tsx' 2>/dev/null | wc -l)" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "✅ All checks passed successfully" >> pr-verification/build-report.txt
      
      - name: Upload PR verification artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: pr-verification-${{ github.event.pull_request.number }}-${{ github.sha }}
          path: pr-verification/
          retention-days: 2
          compression-level: 6
      
      - name: Prepare staging deployment package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "📦 Creating staging deployment package..."
          
          mkdir -p deployment-package
          
          # Copy production-necessary files (no src needed)
          echo "📁 Copying production files..."
          cp -r .next deployment-package/
          cp -r public deployment-package/ 2>/dev/null || echo "ℹ️ No public directory"
          cp package.json deployment-package/
          cp package-lock.json deployment-package/
          cp next.config.mjs deployment-package/
          
          # Remove development artifacts
          echo "🧹 Removing development artifacts..."
          rm -rf deployment-package/.next/cache
          find deployment-package -name "*.map" -type f -delete 2>/dev/null || true
          
          # Verify package integrity
          echo "🔍 Verifying deployment package..."
          if [ ! -d "deployment-package/.next" ]; then
            echo "❌ FATAL: .next missing from package!"
            exit 1
          fi
          
          echo "✅ Package verified successfully"
          echo ""
          echo "📊 Staging deployment package statistics:"
          echo "  Total size: $(du -sh deployment-package | cut -f1)"
          echo "  .next size: $(du -sh deployment-package/.next | cut -f1)"
          echo ""
          echo "📦 Package contents:"
          echo "  ✅ .next/ (compiled application)"
          echo "  ✅ public/ (static assets)"
          echo "  ✅ package.json, package-lock.json"
          echo "  ✅ next.config.mjs"
          echo "  ❌ src/ (NOT included - not needed in production)"
      
      - name: Upload staging deployment artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: staging-package-${{ github.sha }}
          path: deployment-package/
          retention-days: 14  
          compression-level: 6
          include-hidden-files: true
      
      - name: Pipeline summary
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "🎉 CI Pipeline completed successfully!"
          echo ""
          echo "Next steps:"
          echo "- Staging deployment will be triggered automatically"
          echo "- Test your changes at: https://${{ secrets.STAGING_DOMAIN_1 }}"
          echo "- When ready for production, run: npm run release"