# CI Pipeline - Final optimization without src folder
# Location: .github/workflows/ci.yml
# Version: Stage 4 - Removed src from deployment artifacts

name: CI Pipeline

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  validate-and-build:
    name: Validate and Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      
      - name: Install dependencies with cache optimization
        env:
          EMERGENCY_NPM_BYPASS: ${{ vars.EMERGENCY_NPM_BYPASS }}
        run: |
          echo "ğŸš€ Phase 1: Optimized npm installation with cache strategy"
          echo "ğŸ” Environment check:"
          echo "- Node version: $(node --version)"
          echo "- NPM version: $(npm --version)"
          echo "- Registry: $(npm config get registry)"
          echo "- Cache location: $(npm config get cache)"
          echo "- Emergency bypass: ${EMERGENCY_NPM_BYPASS:-false}"
          
          # Check if emergency bypass is enabled
          if [ "${EMERGENCY_NPM_BYPASS}" = "true" ]; then
            echo "ğŸš¨ Emergency bypass enabled - using simple npm ci"
            npm ci --timeout=300000
            exit 0
          fi
          
          # Start timer for performance metrics
          start_time=$(date +%s)
          
          echo "ğŸ“¦ Installing dependencies with cache optimization..."
          
          # Phase 1: Cache-optimized installation with single attempt
          if npm ci --prefer-offline --no-audit --no-fund --timeout=180000; then
            end_time=$(date +%s)
            duration=$((end_time - start_time))
            echo "âœ… Dependencies installed successfully in ${duration} seconds"
            
            # Performance metrics
            echo "npm_install_duration=${duration}" >> $GITHUB_STEP_SUMMARY
            echo "npm_install_attempts=1" >> $GITHUB_STEP_SUMMARY
            echo "npm_cache_strategy=prefer-offline" >> $GITHUB_STEP_SUMMARY
            echo "npm_registry_used=primary" >> $GITHUB_STEP_SUMMARY
            
          else
            end_time=$(date +%s)
            duration=$((end_time - start_time))
            echo "âŒ Installation failed after ${duration} seconds"
            echo "ğŸ“Š Failure diagnostics:"
            echo "- Exit code: $?"
            echo "- Duration: ${duration}s"
            echo "- Registry: $(npm config get registry)"
            echo "- Network: $(curl -s --connect-timeout 5 https://registry.npmjs.org/ > /dev/null && echo 'OK' || echo 'FAILED')"
            
            # Log failure metrics
            echo "npm_install_duration=${duration}" >> $GITHUB_STEP_SUMMARY
            echo "npm_install_attempts=1" >> $GITHUB_STEP_SUMMARY
            echo "npm_failure_reason=phase1_failed" >> $GITHUB_STEP_SUMMARY
            
            echo "ğŸ’€ Phase 1 installation failed. Future phases will be implemented if needed."
            exit 1
          fi
          
          echo "ğŸ“‹ Final dependency verification:"
          npm list --depth=0 || echo "âš ï¸ Some dependencies may have issues, but installation completed"
          
          # Specific check for problematic packages
          echo "ğŸ” Checking for zustand..."
          if npm list zustand 2>/dev/null; then
            echo "âœ… zustand successfully installed"
          else
            echo "âš ï¸ zustand not found in dependency tree (may be indirect)"
          fi
          
          echo "ğŸ‰ Phase 1 cache-optimized installation complete!"
      
      - name: Run linter
        run: npm run lint
      
      - name: Run tests
        run: npm test
      
      - name: Build project
        env:
          NEXT_PUBLIC_WEB3_SHARED_ACCESS_CODE: ${{ secrets.NEXT_PUBLIC_WEB3_SHARED_ACCESS_CODE }}
        run: |
          echo "ğŸ—ï¸ Building project..."
          npm run build
          
          # Verify build succeeded
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed - .next directory not found"
            exit 1
          fi
          
          echo "âœ… Build complete"
          echo "ğŸ“Š Build stats:"
          echo "  Total size: $(du -sh .next | cut -f1)"
          echo "  Static assets: $(du -sh .next/static | cut -f1)"
          echo "  Server bundles: $(du -sh .next/server | cut -f1)"
      
      # FOR PULL REQUESTS: Create lightweight verification report
      - name: Create PR verification artifact
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ“ Creating PR verification report..."
          
          mkdir -p pr-verification
          
          echo "Build Verification Report" > pr-verification/build-report.txt
          echo "=========================" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "PR #${{ github.event.pull_request.number }}" >> pr-verification/build-report.txt
          echo "Commit: ${{ github.sha }}" >> pr-verification/build-report.txt
          echo "Branch: ${{ github.head_ref }}" >> pr-verification/build-report.txt
          echo "Build Time: $(date)" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "Build Statistics:" >> pr-verification/build-report.txt
          echo "- Total .next size: $(du -sh .next | cut -f1)" >> pr-verification/build-report.txt
          echo "- Source files analyzed: $(find src -type f -name '*.js' -o -name '*.jsx' -o -name '*.ts' -o -name '*.tsx' 2>/dev/null | wc -l)" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "âœ… All checks passed successfully" >> pr-verification/build-report.txt
      
      - name: Upload PR verification artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: pr-verification-${{ github.event.pull_request.number }}-${{ github.sha }}
          path: pr-verification/
          retention-days: 2
          compression-level: 6
      
      # FOR MAIN BRANCH: Create optimized deployment package
      - name: Prepare deployment package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ“¦ Creating optimized deployment package..."
          
          mkdir -p deployment-package
          
          # Copy ONLY production-necessary files
          # Note: src folder is NOT included - it's not needed for production!
          echo "ğŸ“ Copying production files..."
          cp -r .next deployment-package/
          cp -r public deployment-package/ 2>/dev/null || echo "â„¹ï¸ No public directory"
          cp package.json deployment-package/
          cp package-lock.json deployment-package/
          cp next.config.mjs deployment-package/
          
          # Remove development artifacts to minimize size
          echo "ğŸ§¹ Removing development artifacts..."
          rm -rf deployment-package/.next/cache
          find deployment-package -name "*.map" -type f -delete 2>/dev/null || true
          
          # Verify package integrity
          echo "ğŸ” Verifying deployment package..."
          if [ ! -d "deployment-package/.next" ]; then
            echo "âŒ FATAL: .next missing from package!"
            exit 1
          fi
          
          if [ ! -d "deployment-package/.next/static" ]; then
            echo "âŒ FATAL: .next/static missing!"
            exit 1
          fi
          
          if [ ! -d "deployment-package/.next/server" ]; then
            echo "âŒ FATAL: .next/server missing!"
            exit 1
          fi
          
          if [ ! -f "deployment-package/package.json" ]; then
            echo "âŒ FATAL: package.json missing!"
            exit 1
          fi
          
          echo "âœ… Package verified successfully"
          echo ""
          echo "ğŸ“Š Deployment package statistics:"
          echo "  Total size: $(du -sh deployment-package | cut -f1)"
          echo "  .next size: $(du -sh deployment-package/.next | cut -f1)"
          if [ -d "deployment-package/public" ]; then
            echo "  public size: $(du -sh deployment-package/public | cut -f1)"
          fi
          echo ""
          echo "ğŸ“¦ Package contents:"
          echo "  âœ… .next/ (compiled application)"
          echo "  âœ… public/ (static assets)"
          echo "  âœ… package.json, package-lock.json"
          echo "  âœ… next.config.mjs"
          echo "  âŒ src/ (NOT included - not needed in production)"
      
      # Upload optimized deployment artifact
      - name: Upload deployment artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package-${{ github.sha }}
          path: deployment-package/
          retention-days: 14
          compression-level: 6
          include-hidden-files: true
      
      - name: Optimization summary
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ‰ Optimized deployment package created!"
          echo ""
          echo "Optimization results:"
          echo "âœ… Removed src folder (not needed in production)"
          echo "âœ… Removed .next/cache (development only)"
          echo "âœ… Removed source maps (development only)"
          echo ""
          echo "The deployment package now contains ONLY what's needed for production."
          echo "Expected benefits: faster uploads, faster deployments, improved security."