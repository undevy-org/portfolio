# CI Pipeline - Final optimization without src folder
# Location: .github/workflows/ci.yml
# Version: Stage 4 - Removed src from deployment artifacts

name: CI Pipeline

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  validate-and-build:
    name: Validate and Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run tests
        run: npm test
      
      - name: Build project
        run: |
          echo "🏗️ Building project..."
          npm run build
          
          # Verify build succeeded
          if [ ! -d ".next" ]; then
            echo "❌ Build failed - .next directory not found"
            exit 1
          fi
          
          echo "✅ Build complete"
          echo "📊 Build stats:"
          echo "  Total size: $(du -sh .next | cut -f1)"
          echo "  Static assets: $(du -sh .next/static | cut -f1)"
          echo "  Server bundles: $(du -sh .next/server | cut -f1)"
      
      # FOR PULL REQUESTS: Create lightweight verification report
      - name: Create PR verification artifact
        if: github.event_name == 'pull_request'
        run: |
          echo "📝 Creating PR verification report..."
          
          mkdir -p pr-verification
          
          echo "Build Verification Report" > pr-verification/build-report.txt
          echo "=========================" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "PR #${{ github.event.pull_request.number }}" >> pr-verification/build-report.txt
          echo "Commit: ${{ github.sha }}" >> pr-verification/build-report.txt
          echo "Branch: ${{ github.head_ref }}" >> pr-verification/build-report.txt
          echo "Build Time: $(date)" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "Build Statistics:" >> pr-verification/build-report.txt
          echo "- Total .next size: $(du -sh .next | cut -f1)" >> pr-verification/build-report.txt
          echo "- Source files analyzed: $(find src -type f -name '*.js' -o -name '*.jsx' -o -name '*.ts' -o -name '*.tsx' 2>/dev/null | wc -l)" >> pr-verification/build-report.txt
          echo "" >> pr-verification/build-report.txt
          echo "✅ All checks passed successfully" >> pr-verification/build-report.txt
      
      - name: Upload PR verification artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: pr-verification-${{ github.event.pull_request.number }}-${{ github.sha }}
          path: pr-verification/
          retention-days: 2
          compression-level: 6
      
      # FOR MAIN BRANCH: Create optimized deployment package
      - name: Prepare deployment package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "📦 Creating optimized deployment package..."
          
          mkdir -p deployment-package
          
          # Copy ONLY production-necessary files
          # Note: src folder is NOT included - it's not needed for production!
          echo "📁 Copying production files..."
          cp -r .next deployment-package/
          cp -r public deployment-package/ 2>/dev/null || echo "ℹ️ No public directory"
          cp package.json deployment-package/
          cp package-lock.json deployment-package/
          cp next.config.mjs deployment-package/
          
          # Remove development artifacts to minimize size
          echo "🧹 Removing development artifacts..."
          rm -rf deployment-package/.next/cache
          find deployment-package -name "*.map" -type f -delete 2>/dev/null || true
          
          # Verify package integrity
          echo "🔍 Verifying deployment package..."
          if [ ! -d "deployment-package/.next" ]; then
            echo "❌ FATAL: .next missing from package!"
            exit 1
          fi
          
          if [ ! -d "deployment-package/.next/static" ]; then
            echo "❌ FATAL: .next/static missing!"
            exit 1
          fi
          
          if [ ! -d "deployment-package/.next/server" ]; then
            echo "❌ FATAL: .next/server missing!"
            exit 1
          fi
          
          if [ ! -f "deployment-package/package.json" ]; then
            echo "❌ FATAL: package.json missing!"
            exit 1
          fi
          
          echo "✅ Package verified successfully"
          echo ""
          echo "📊 Deployment package statistics:"
          echo "  Total size: $(du -sh deployment-package | cut -f1)"
          echo "  .next size: $(du -sh deployment-package/.next | cut -f1)"
          if [ -d "deployment-package/public" ]; then
            echo "  public size: $(du -sh deployment-package/public | cut -f1)"
          fi
          echo ""
          echo "📦 Package contents:"
          echo "  ✅ .next/ (compiled application)"
          echo "  ✅ public/ (static assets)"
          echo "  ✅ package.json, package-lock.json"
          echo "  ✅ next.config.mjs"
          echo "  ❌ src/ (NOT included - not needed in production)"
      
      # Upload optimized deployment artifact
      - name: Upload deployment artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package-${{ github.sha }}
          path: deployment-package/
          retention-days: 14
          compression-level: 6
          include-hidden-files: true
      
      - name: Optimization summary
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "🎉 Optimized deployment package created!"
          echo ""
          echo "Optimization results:"
          echo "✅ Removed src folder (not needed in production)"
          echo "✅ Removed .next/cache (development only)"
          echo "✅ Removed source maps (development only)"
          echo ""
          echo "The deployment package now contains ONLY what's needed for production."
          echo "Expected benefits: faster uploads, faster deployments, improved security."