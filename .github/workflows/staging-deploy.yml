# Staging Deployment Pipeline
# Location: .github/workflows/staging-deploy.yml
# Purpose: Deploy to staging environment after successful CI on main branch

name: Deploy to Staging

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    
    steps:
      - name: Setup deployment info
        run: |
          echo "üöÄ Starting STAGING deployment"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"
          echo "Triggered by: ${{ github.event.workflow_run.name }}"
          echo "Run ID: ${{ github.event.workflow_run.id }}"
          echo "Target: ${{ secrets.STAGING_DOMAIN_1 }} / ${{ secrets.STAGING_DOMAIN_2 }}"
      
      - name: Download staging artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml  # –í–∞–∂–Ω–æ! –£–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
          run_id: ${{ github.event.workflow_run.id }}
          name: staging-package-${{ github.event.workflow_run.head_sha }}
          path: deployment-files
      
      - name: Verify and prepare artifact
        run: |
          echo "üì¶ Verifying downloaded artifact..."
          
          echo "üìÅ Downloaded contents:"
          ls -la deployment-files/
          
          # Check for .next directory
          if [ ! -d "deployment-files/.next" ]; then
            echo "‚ùå ERROR: .next directory not found in artifact!"
            exit 1
          fi
          
          echo "‚úÖ Found .next directory"
          echo "üìä .next size: $(du -sh deployment-files/.next | cut -f1)"
          
          if [ ! -f "deployment-files/package.json" ]; then
            echo "‚ùå ERROR: package.json not found!"
            exit 1
          fi
          
          echo "‚úÖ All required files present"
          
          # Create deployment archive in workspace (not /tmp/ - scp-action can only access workspace)
          echo "üì¶ Creating deployment archive..."
          cd deployment-files
          tar -czf ../staging-deploy.tar.gz .
          cd ..
          echo "‚úÖ Archive created: $(du -h staging-deploy.tar.gz | cut -f1)"
      
      - name: Prepate artifact directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p /home/undevy/releases/staging/artifacts

      - name: Transfer files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "staging-deploy.tar.gz"
          target: "/home/undevy/releases/staging/artifacts"

      - name: Deploy to staging environment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            echo "üîß Verifying Node environment..."
            if ! command -v node &> /dev/null; then
              echo "‚ùå FATAL: Node.js not found"
              exit 1
            fi

            echo "‚úÖ Node version: $(node --version)"
            echo "‚úÖ npm version: $(npm --version)"
            echo "‚úÖ PM2 version: $(pm2 --version)"
            
            STAGING_PATH="/home/undevy/releases/staging/current"
            TEMP_PATH="/home/undevy/releases/staging/temp-$(date +%s)"
            ARTIFACT_PATH="/home/undevy/releases/staging/artifacts/staging-deploy.tar.gz"
            
            echo "üîç Debugging artifact location:"
            ls -la /home/undevy/releases/staging/artifacts/
            
            if [ ! -f "$ARTIFACT_PATH" ]; then
                echo "‚ùå FATAL: Artifact not found at $ARTIFACT_PATH"
                exit 1
            fi
            
            # Create staging directories if they don't exist
            mkdir -p /home/undevy/releases/staging
            
            # Create temporary deployment directory
            echo "üìÅ Creating temporary deployment directory..."
            mkdir -p "$TEMP_PATH"
            
            # Extract new files
            echo "üì¶ Extracting staging files..."
            tar -xzf "$ARTIFACT_PATH" -C "$TEMP_PATH"

            # Ensure no duplicate image directories (but preserve template.webp)
            echo "üßπ Ensuring clean static assets setup..."
            rm -rf "$TEMP_PATH/public/images/projects" || true
            echo "‚úÖ Static assets will be served directly by Nginx"
            
            # Copy staging environment file
            echo "üíæ Applying staging environment configuration..."
            if [ -f "${{ secrets.SHARED_ENV_PATH_STAGING }}/.env" ]; then
              cp "${{ secrets.SHARED_ENV_PATH_STAGING }}/.env" "$TEMP_PATH/.env"
            else
              echo "‚ö†Ô∏è Warning: No staging .env file found, creating minimal config..."
              echo "NODE_ENV=development" > "$TEMP_PATH/.env"
              echo "PORT=3001" >> "$TEMP_PATH/.env"
            fi
            
            # Preserve user-uploaded images if they exist
            if [ -d "$STAGING_PATH/public/images/projects" ]; then
              echo "üì∏ Preserving user-uploaded images..."
              mkdir -p "$TEMP_PATH/public/images"
              cp -r "$STAGING_PATH/public/images/projects" "$TEMP_PATH/public/images/" || true
            fi
            
            # Swap directories
            echo "üîÑ Swapping staging directories..."
            if [ -d "$STAGING_PATH" ]; then
              rm -rf "$STAGING_PATH.old"
              mv "$STAGING_PATH" "$STAGING_PATH.old"
            fi
            mv "$TEMP_PATH" "$STAGING_PATH"
            
            cd "$STAGING_PATH"
            
            # Verify standalone build
            if [ ! -f "server.js" ]; then
               echo "‚ùå FATAL: server.js not found in deployment!"
               exit 1
            fi
            
            # Generate images from template (using server content.json or staging env)
            echo "üñºÔ∏è Generating missing images..."
            export CONTENT_FILE_PATH=$HOME/content.json
            export IMAGES_DIR=$HOME/static-assets/images/projects
            node scripts/ensure_images.js || echo "‚ö†Ô∏è Image generation warning (non-fatal)"
            
            # Stop existing staging process if running
            echo "üîç Checking for existing staging process..."
            if pm2 describe "staging-portfolio" >/dev/null 2>&1; then
              echo "‚èπÔ∏è Stopping existing staging process..."
              pm2 stop "staging-portfolio"
              pm2 delete "staging-portfolio"
            fi
            
            # Start staging application with auto-shutdown after 2 hours
            # Standalone mode: Run server.js directly (no npm start)
            echo "üöÄ Starting staging application (Standalone Mode)..."
            cd "$STAGING_PATH"
            PORT=3001 APP_ENV=staging pm2 start server.js --name "staging-portfolio" \
              --max-memory-restart="200M" \
              --env production
            
            # Sync favicons to static-assets (since Nginx serves from there)
            echo "üñºÔ∏è Syncing favicons to static-assets..."
            STATIC_FAVICONS="$HOME/static-assets/images/favicons"
            mkdir -p "$STATIC_FAVICONS"
            # Copy contents of favicons from release to static-assets
            # careful not to use public/images/projects which is huge
            if [ -d "$STAGING_PATH/public/images/favicons" ]; then
                cp -r "$STAGING_PATH/public/images/favicons/." "$STATIC_FAVICONS/"
                echo "‚úÖ Favicons synced to $STATIC_FAVICONS"
            else
                echo "‚ö†Ô∏è WARNING: Favicons not found in release at $STAGING_PATH/public/images/favicons"
            fi
            
            # Show application status
            echo "üìä Staging application status:"
            pm2 list | grep "staging-portfolio" || true
            
            # Set up auto-shutdown timer (will be implemented in Phase 3)
            echo "‚è∞ Note: Auto-shutdown after 2 hours will be configured in Phase 3"
            
            # Cleanup
            echo "üßπ Cleaning up..."
            rm -f /tmp/staging-deploy.tar.gz
            rm -rf "$STAGING_PATH.old" || true
            
            echo "‚úÖ Staging deployment completed!"
            echo ""
            echo "üåê Access staging at:"
            echo "  - https://${{ secrets.STAGING_DOMAIN_1 }}"
            echo "  - https://${{ secrets.STAGING_DOMAIN_2 }}"
      
      - name: Deployment summary
        run: |
          echo "üéâ STAGING DEPLOYMENT SUCCESSFUL!"
          echo "================================"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"
          echo ""
          echo "Staging sites are now live at:"
          echo "  üåê https://${{ secrets.STAGING_DOMAIN_1 }}"
          echo "  üåê https://${{ secrets.STAGING_DOMAIN_2 }}"
          echo ""
          echo "Note: Staging will auto-shutdown after 2 hours of inactivity"
          echo "To promote to production, run: npm run release"
  
  failure-notification:
    name: Handle CI Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Report CI failure
        run: |
          echo "‚ùå CI Pipeline failed!"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"
          echo "Staging deployment cancelled due to failed tests or build."
          echo "Check the failed run: ${{ github.event.workflow_run.html_url }}"
          exit 1
